#!/bin/bash

# ==============================================================================
# TITRE : Setup Debian 13
# DESCRIPTION : Mises à jour, Outils, Netbios, Bashrc, Webmin, MiniJeux
# ==============================================================================

#===============================================================================
# 1. Sécurité : Arrêt du script en cas d'erreur
#===============================================================================

set -e

if [ "$EUID" -ne 0 ]; then
  echo "Erreur : Ce script doit être lancé en root (ou avec sudo)."
  exit 1
fi

# ==============================================================================
# 2. DÉFINITION DES VARIABLES
# ==============================================================================

PAQUETS_BASE="ssh zip unzip nmap locate ncdu curl git screen dnsutils net-tools sudo lynx"
PAQUETS_SAMBA="winbind samba"
PAQUETS_JEUX="bsdgames"

echo "Démarrage du script d'installation..."

# ==============================================================================
# 3. MISE À JOUR ET INSTALLATIONS
# ==============================================================================

echo "[1/5] Mise à jour du système..."

apt update && apt upgrade -y

echo "[2/5] Installation des paquets de base..."
apt install -y $PAQUETS_BASE

echo "Installation des composants Samba/Netbios..."
apt install -y $PAQUETS_SAMBA

echo "Installation du Bonus Fun..."
apt install -y $PAQUETS_JEUX

# ==============================================================================
# 4. CONFIGURATION SYSTÈME & FICHIERS
# ==============================================================================

echo "[3/5] Configuration des fichiers systèmes..."

echo "   -> Mise à jour de l'index locate..."
updatedb

if ! grep -q "wins" /etc/nsswitch.conf; then
    sed -i '/^hosts:/ s/$/ wins/' /etc/nsswitch.conf
    echo "   -> WINS ajouté à nsswitch.conf."
else
    echo "   -> WINS était déjà configuré."
fi

echo "   -> Activation des couleurs dans le .bashrc..."
sed -i '9,13s/^#//' /root/.bashrc

# ==============================================================================
# 5. INSTALLATION WEBMIN
# ==============================================================================

echo "[4/5] Installation de Webmin..."

curl -o webmin-setup-repo.sh https://raw.githubusercontent.com/webmin/webmin/master/webmin-setup-repo.sh

sh webmin-setup-repo.sh --force

apt install -y webmin --install-recommends

rm webmin-setup-repo.sh

# ==============================================================================
# 6. FIN
# ==============================================================================

echo "======================================================="
echo "TERMINÉ ! L'installation est finie."
echo "======================================================="
echo "Infos :"
echo "   - Ton IP actuelle (DHCP) est :"
ip -4 a | grep inet | grep -v "127.0.0.1" | awk '{print $2}'
echo ""
echo "   - Webmin accessible via : https://TON_IP:10000"
echo "   - Jeux disponibles dans /usr/games"
echo ""

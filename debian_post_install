#!/bin/bash

# ==============================================================================
# TITRE : Script Setup Debian 13 (Version Safe - Pas de config IP)
# DESCRIPTION : Mises √† jour, Outils, Netbios, Bashrc, Webmin, Jeux
# ==============================================================================

# 1. S√©curit√© : Arr√™t imm√©diat en cas d'erreur
set -e

# V√©rification root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Erreur : Ce script doit √™tre lanc√© en root (ou avec sudo)."
  exit 1
fi

# ==============================================================================
# 2. D√âFINITION DES VARIABLES
# ==============================================================================
# Liste des paquets √† installer
PAQUETS_BASE="ssh zip unzip nmap locate ncdu curl git screen dnsutils net-tools sudo lynx"
PAQUETS_SAMBA="winbind samba"
PAQUETS_FUN="bsdgames"

echo "üöÄ D√©marrage du script d'installation..."

# ==============================================================================
# 3. MISE √Ä JOUR ET INSTALLATIONS
# ==============================================================================
echo "üîÑ [1/5] Mise √† jour du syst√®me..."
# On met √† jour la liste et on installe les patchs
apt update && apt upgrade -y

echo "üì¶ [2/5] Installation des paquets de base..."
apt install -y $PAQUETS_BASE

echo "üì¶ Installation des composants Samba/Netbios..."
apt install -y $PAQUETS_SAMBA

echo "üéÆ Installation du Bonus Fun..."
apt install -y $PAQUETS_FUN

# ==============================================================================
# 4. CONFIGURATION SYST√àME & FICHIERS
# ==============================================================================
echo "‚öôÔ∏è [3/5] Configuration des fichiers syst√®mes..."

# 4.1 Locate (Indexation des fichiers)
echo "   -> Mise √† jour de l'index locate..."
updatedb

# 4.2 Netbios (nsswitch.conf)
# On v√©rifie si 'wins' est d√©j√† pr√©sent pour ne pas le mettre deux fois
if ! grep -q "wins" /etc/nsswitch.conf; then
    # Commande sed pour ajouter 'wins' √† la fin de la ligne hosts
    sed -i '/^hosts:/ s/$/ wins/' /etc/nsswitch.conf
    echo "   -> WINS ajout√© √† nsswitch.conf."
else
    echo "   -> WINS √©tait d√©j√† configur√©."
fi

# 4.3 Personnalisation du BASH (.bashrc)
# On active la couleur et les alias en d√©commentant les lignes 9 √† 13
echo "   -> Activation des couleurs dans le .bashrc..."
sed -i '9,13s/^#//' /root/.bashrc

# ==============================================================================
# 5. INSTALLATION WEBMIN
# ==============================================================================
echo "üîß [4/5] Installation de Webmin..."

# T√©l√©chargement du script d'installation officiel
curl -o webmin-setup-repo.sh https://raw.githubusercontent.com/webmin/webmin/master/webmin-setup-repo.sh

# Ex√©cution du script de repo (ajout des cl√©s de s√©curit√© Webmin)
sh webmin-setup-repo.sh --force

# Installation du paquet final
apt install -y webmin --install-recommends

# Nettoyage du fichier temporaire
rm webmin-setup-repo.sh

# ==============================================================================
# 6. FIN
# ==============================================================================
echo "======================================================="
echo "‚úÖ TERMIN√â ! L'installation est finie."
echo "======================================================="
echo "‚ÑπÔ∏è  Infos :"
echo "   - Ton IP actuelle (DHCP) est :"
# On affiche l'IP pour que tu saches o√π te connecter
ip -4 a | grep inet | grep -v "127.0.0.1" | awk '{print $2}'
echo ""
echo "   - Webmin accessible via : https://TON_IP:10000"
echo "   - Jeux disponibles dans /usr/games"
echo ""
echo "üí° Astuce : Pour prendre en compte le changement du .bashrc,"
echo "   d√©connecte-toi et reconnecte-toi (ou tape : source ~/.bashrc)"
